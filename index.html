<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãŸã‹ã¡ã‚ƒã‚“ã‚¿ã‚¯ã‚·ãƒ¼MAP(å®Œå…¨ç‰ˆ)</title>
    <style>
        /* ç”»é¢ã„ã£ã±ã„ã«åœ°å›³ã‚’å‡ºã™ãŸã‚ã®åŸºæœ¬è¨­å®š */
        html, body { height: 100%; margin: 0; padding: 0; font-family: sans-serif; }
        #map { height: 100%; width: 100%; background: #e5e3df; }
        
        /* ã‚‚ã—ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸã‚‰è¡¨ç¤ºã™ã‚‹èµ¤ã„ç®± */
        #error-message {
            display: none; position: fixed; top: 10%; left: 5%; width: 90%; 
            background: #ffe6e6; color: #d8000c; padding: 15px; 
            border: 1px solid #d8000c; border-radius: 5px; z-index: 9999;
            font-weight: bold; white-space: pre-wrap;
        }

        /* ãƒœã‚¿ãƒ³é¡ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .control-panel { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; width: 90%; display: flex; gap: 10px; }
        button { flex: 1; padding: 15px; border-radius: 30px; border: none; font-size: 16px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.2); cursor: pointer; }
        .gps-btn { background: #007aff; color: #fff; }
        .list-btn { background: #333; color: #fff; }

        /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
        #input-form {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; background: white; z-index: 3000; display: none;
            padding: 20px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        input { width: 100%; padding: 10px; margin: 5px 0 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; box-sizing: border-box; }
        
        /* ãƒªã‚¹ãƒˆè¡¨ç¤º */
        #list-overlay { position: fixed; bottom: 0; left: 0; width: 100%; height: 70%; background: white; z-index: 2000; display: none; overflow-y: auto; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); }
        .list-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; position: sticky; top: 0; background: white; font-weight: bold; }
        .list-content { padding: 10px; }
        .list-item { padding: 10px; border-bottom: 1px solid #f0f0f0; }
    </style>
</head>
<body>

    <div id="error-message"></div>
    
    <div id="map"></div>

    <div id="input-form">
        <h3 style="margin-top:0; text-align:center;">å£²ä¸Šå…¥åŠ›</h3>
        <label>å£²ä¸Šï¼ˆå††ï¼‰</label>
        <input type="number" id="sales-input" placeholder="1200" inputmode="numeric">
        <label>å ´æ‰€ï¼ˆè‡ªå‹•ï¼‰</label>
        <input type="text" id="area-input">
        <div style="display:flex; gap:10px;">
            <button onclick="saveMemo()" style="background:#ffcc00; color:#000;">ä¿å­˜</button>
            <button onclick="closeForm()" style="background:#eee; color:#333;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <div class="control-panel">
        <button class="gps-btn" onclick="goToCurrentLocation()">ğŸ“ ç¾åœ¨åœ°</button>
        <button class="list-btn" onclick="toggleList()">ğŸ“Š å£²ä¸Šãƒªã‚¹ãƒˆ</button>
    </div>

    <div id="list-overlay">
        <div class="list-header">
            <span id="total-summary">ç·å£²ä¸Š: Â¥0</span>
            <span onclick="toggleList()" style="color:#888;">é–‰ã˜ã‚‹</span>
        </div>
        <div id="memo-list-content" class="list-content"></div>
    </div>

    <script>
        // ã‚¨ãƒ©ãƒ¼ã‚’æ•ã¾ãˆã‚‹ç½ ã‚’ä»•æ›ã‘ã‚‹
        window.onerror = function(msg, url, line) {
            const errDiv = document.getElementById('error-message');
            errDiv.style.display = 'block';
            errDiv.innerHTML = "âš ï¸ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿï¼<br>" + msg + "<br>(è¡Œ: " + line + ")";
            return false;
        };

        let map, geocoder, currentMarker, markers = [];
        let selectedLat, selectedLng;

        // åœ°å›³ã®æº–å‚™ã‚’ã™ã‚‹é–¢æ•°ï¼ˆã“ã‚Œã‚’GoogleãŒå‘¼ã³å‡ºã™ï¼‰
        function initMap() {
            try {
                map = new google.maps.Map(document.getElementById('map'), {
                    center: {lat: 33.5902, lng: 130.4017}, // åšå¤šé§…å‘¨è¾º
                    zoom: 15,
                    disableDefaultUI: true, // ä½™è¨ˆãªãƒœã‚¿ãƒ³ã‚’æ¶ˆã™
                    clickableIcons: false   // ãŠåº—ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ä¸å¯ã«ã™ã‚‹
                });
                
                geocoder = new google.maps.Geocoder();

                // åœ°å›³ã‚’ã‚¿ãƒƒãƒ—ã—ãŸæ™‚ã®å‡¦ç†
                map.addListener('click', function(e) {
                    selectedLat = e.latLng.lat();
                    selectedLng = e.latLng.lng();
                    document.getElementById('input-form').style.display = 'block';
                    
                    // ä½æ‰€ã‚’èª¿ã¹ã‚‹
                    geocoder.geocode({ location: e.latLng }, function(results, status) {
                        if (status === "OK" && results[0]) {
                            // "ç¦å²¡å¸‚åšå¤šåŒº" ã¿ãŸã„ãªéƒ¨åˆ†ã‚’ã†ã¾ãæŠœãå‡ºã™
                            let addr = results[0].address_components;
                            let areaName = "ä¸æ˜";
                            // ç”ºåãªã©ã‚’æ¢ã™ãƒ­ã‚¸ãƒƒã‚¯
                            for (let i = 0; i < addr.length; i++) {
                                if (addr[i].types.includes("sublocality_level_2") || addr[i].types.includes("sublocality_level_1")) {
                                    areaName = addr[i].long_name;
                                    break;
                                }
                            }
                            document.getElementById('area-input').value = areaName;
                        }
                    });
                });

                renderMemos(); // ä¿å­˜ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                goToCurrentLocation(); // èµ·å‹•æ™‚ã«ç¾åœ¨åœ°ã¸

            } catch (e) {
                alert("åœ°å›³ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸ: " + e);
            }
        }

        // ç¾åœ¨åœ°ã¸ç§»å‹•
        function goToCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(pos) {
                    const latlng = {lat: pos.coords.latitude, lng: pos.coords.longitude};
                    map.setCenter(latlng);
                    map.setZoom(17);
                    
                    if (currentMarker) currentMarker.setMap(null);
                    currentMarker = new google.maps.Marker({
                        position: latlng,
                        map: map,
                        title: "ç¾åœ¨åœ°",
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 10,
                            fillColor: "#4285F4",
                            fillOpacity: 1,
                            strokeWeight: 2,
                            strokeColor: "white"
                        }
                    });
                }, function() {
                    // GPSå–å¾—å¤±æ•—
                    console.log("GPSã®è¨±å¯ãŒå¿…è¦ã§ã™");
                });
            }
        }

        // ä¿å­˜ãƒœã‚¿ãƒ³
        function saveMemo() {
            const sales = Number(document.getElementById('sales-input').value);
            const area = document.getElementById('area-input').value || "å ´æ‰€ä¸æ˜";
            
            if (!sales) { alert("å£²ä¸Šã‚’å…¥ã‚Œã¦ã­ï¼"); return; }

            const data = {
                lat: selectedLat,
                lng: selectedLng,
                sales: sales,
                area: area,
                time: new Date().toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'})
            };

            let list = JSON.parse(localStorage.getItem('taxi_sales_v1') || '[]');
            list.push(data);
            localStorage.setItem('taxi_sales_v1', JSON.stringify(list));
            
            closeForm();
            renderMemos();
            alert("è¨˜éŒ²ã—ã¾ã—ãŸï¼");
        }

        // ãƒªã‚¹ãƒˆã¨ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤º
        function renderMemos() {
            // å‰ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’æ¶ˆã™
            markers.forEach(m => m.setMap(null));
            markers = [];

            const list = JSON.parse(localStorage.getItem('taxi_sales_v1') || '[]');
            const listDiv = document.getElementById('memo-list-content');
            listDiv.innerHTML = "";
            let total = 0;

            list.forEach(function(item) {
                total += item.sales;
                
                // åœ°å›³ã«ãƒ”ãƒ³ã‚’ç«‹ã¦ã‚‹
                const marker = new google.maps.Marker({
                    position: {lat: item.lat, lng: item.lng},
                    map: map,
                    label: { text: "Â¥" + item.sales, color: "black", fontSize: "12px", fontWeight: "bold" }
                });
                markers.push(marker);

                // ãƒªã‚¹ãƒˆã«è¿½åŠ 
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `<b>${item.area}</b> <span style="float:right">Â¥${item.sales}</span><br><small>${item.time}</small>`;
                listDiv.appendChild(div);
            });

            document.getElementById('total-summary').innerText = "ğŸ’° ç·å£²ä¸Š: Â¥" + total.toLocaleString();
        }

        function closeForm() {
            document.getElementById('input-form').style.display = 'none';
            document.getElementById('sales-input').value = '';
        }

        function toggleList() {
            const el = document.getElementById('list-overlay');
            el.style.display = (el.style.display === 'block') ? 'none' : 'block';
        }
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAi0_BQ9-5c3-7sTh1rwevVJlOsYxoLR_4&callback=initMap&libraries=places" async defer></script>

</body>
</html>
